<!DOCTYPE html>
<html>
<head>
  <title>New Uniswap Tokens</title>
</head>
<body>
  <h1>New Uniswap Tokens</h1>
  <button onclick="fetchNewTokens()">Fetch New Tokens</button>
  <div id="tokenList"></div>

  <script src="https://cdn.ethers.io/lib/ethers-5.4.umd.min.js"></script>
  <script>
    // Replace with your Etherscan API key
    const etherscanApiKey = "AFFD2SXUNV3RY968V4442KMBP4928IBMJ7";

    // Uniswap Factory contract address on the Ethereum mainnet
    const uniswapFactoryAddress = "0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f";

    async function fetchNewTokens() {
      const events = await fetchTokenCreationEvents();

      if (events.length === 0) {
        displayNoNewTokens();
      } else {
        const tokens = await fetchTokenInformation(events);
        displayTokens(tokens);
      }
    }

    async function fetchTokenCreationEvents(latestBlock) {
      // The topic0 for PairCreated event is the event signature.
      // It should be a 32-byte hexadecimal value.
      const topic0 = "0xc9c65396";

      const apiUrl = `https://api.etherscan.io/api?module=logs&action=getLogs&fromBlock=17804130&toBlock=latest&address=${uniswapFactoryAddress}&topic0=${topic0}&apikey=${etherscanApiKey}`;

      try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (data.status === "1" && data.message === "OK") {
          return data.result;
        } else {
          console.error("Error fetching token creation events:", data.message);
          throw new Error("Failed to fetch token creation events");
        }
      } catch (error) {
        console.error("Error fetching token creation events:", error);
        throw error;
      }
    }

    async function fetchTokenInformation(events) {
      const tokenPromises = events.map(async (event) => {
        const tokenAddress = event.topics[1].toLowerCase();
        const tokenInfo = await fetchTokenInfo(tokenAddress);
        const contractCode = await fetchContractCode(tokenAddress);
        tokenInfo.contractCode = contractCode;
        return tokenInfo;
      });

      const tokens = await Promise.all(tokenPromises);
      // Sort tokens in descending order based on the latest ones first
      tokens.sort((a, b) => b.timestamp - a.timestamp);
      return tokens;
    }

    async function fetchTokenInfo(tokenAddress) {
      const apiUrl = `https://api.etherscan.io/api?module=token&action=tokeninfo&contractaddress=${tokenAddress}&apikey=${etherscanApiKey}`;

      try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (data.status === "1" && data.message === "OK") {
          return data.result;
        } else {
          console.error("Error fetching token info:", data.message);
          throw new Error("Failed to fetch token info");
        }
      } catch (error) {
        console.error("Error fetching token info:", error);
        throw error;
      }
    }

    async function fetchContractCode(tokenAddress) {
      const apiUrl = `https://api.etherscan.io/api?module=contract&action=getsourcecode&address=${tokenAddress}&apikey=${etherscanApiKey}`;

      try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (data.status === "1" && data.message === "OK") {
          const contractCode = data.result[0].SourceCode || "Contract code not available.";
          return contractCode;
        } else {
          console.error("Error fetching contract code:", data.message);
          return "Failed to fetch contract code";
        }
      } catch (error) {
        console.error("Error fetching contract code:", error);
        return "Failed to fetch contract code";
      }
    }

    function displayTokens(tokens) {
      const tokenListDiv = document.getElementById("tokenList");
      tokenListDiv.innerHTML = "<strong>New Tokens:</strong>";
      const ul = document.createElement("ul");

      tokens.forEach((token) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <p><strong>Name:</strong> ${token.name}</p>
          <p><strong>Symbol:</strong> ${token.symbol}</p>
          <p><strong>Contract Address:</strong> ${token.contractAddress}</p>
          <p><strong>Timestamp:</strong> ${new Date(token.timestamp * 1000).toLocaleString()}</p>
          <p><strong>Liquidity Added:</strong> ${token.liquidityAdded ? "Yes" : "No"}</p>
          <textarea rows="5" cols="50" readonly>${token.contractCode}</textarea>
          <hr>
        `;
        ul.appendChild(li);
      });

      tokenListDiv.appendChild(ul);
    }

    function displayNoNewTokens() {
      const tokenListDiv = document.getElementById("tokenList");
      tokenListDiv.innerHTML = "<p>No new tokens created on Uniswap.</p>";
    }

  </script>
</body>
</html>
